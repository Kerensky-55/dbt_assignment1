WITH rfm_base AS (
    select * from {{ ref("fct_rfm") }}
),
rfm_scored AS (
    SELECT
        customer_id,
        recency,
        frequency,
        monetary_value,
        
        -- Assign RFM scores (quartiles or percentiles)
        NTILE(4) OVER (ORDER BY recency DESC) AS recency_score,   -- Higher recency → lower score
        NTILE(4) OVER (ORDER BY frequency ASC) AS frequency_score, -- More orders → higher score
        NTILE(4) OVER (ORDER BY monetary_value ASC) AS monetary_score -- More spending → higher score

    FROM rfm_base
)

SELECT * FROM rfm_scored
